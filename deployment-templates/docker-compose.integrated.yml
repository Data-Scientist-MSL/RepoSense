version: '3.8'

# Integrated Deployment Pattern
# All services run together with local networking
# Suitable for development and tightly coupled services

services:
  # RepoSense API Service
  reposense:
    image: reposense:${VERSION:-latest}
    container_name: reposense-api
    ports:
      - "${REPOSENSE_PORT:-3000}:3000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=3000
      - OBSERVE_API_URL=http://observe:4000
      - MUAMMAR_API_URL=http://muammar:5000
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    user: "1000:1000"  # Run as non-root user

  # gaI-observe-online Service
  observe:
    image: gai-observe-online:${VERSION:-latest}
    container_name: observe-api
    ports:
      - "${OBSERVE_PORT:-4000}:4000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=4000
      - REPOSENSE_API_URL=http://reposense:3000
      - DATABASE_URL=${DATABASE_URL:-postgresql://user:pass@db:5432/observe}
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - app-network
    depends_on:
      - db
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    user: "1000:1000"

  # muammarlone Service
  muammar:
    image: muammarlone:${VERSION:-latest}
    container_name: muammar-api
    ports:
      - "${MUAMMAR_PORT:-5000}:5000"
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - PORT=5000
      - REPOSENSE_API_URL=http://reposense:3000
      - OBSERVE_API_URL=http://observe:4000
      - LOG_LEVEL=${LOG_LEVEL:-info}
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
    restart: unless-stopped
    user: "1000:1000"

  # Shared Database (Example)
  db:
    image: postgres:15-alpine
    container_name: shared-db
    environment:
      - POSTGRES_USER=${DB_USER:-postgres}
      - POSTGRES_PASSWORD=${DB_PASSWORD:-postgres}
      - POSTGRES_DB=${DB_NAME:-appdb}
    volumes:
      - db-data:/var/lib/postgresql/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

  # Redis Cache (Example)
  cache:
    image: redis:7-alpine
    container_name: shared-cache
    ports:
      - "${REDIS_PORT:-6379}:6379"
    command: redis-server --appendonly yes
    volumes:
      - cache-data:/data
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    restart: unless-stopped

networks:
  app-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  db-data:
    driver: local
  cache-data:
    driver: local
